#!/bin/sh

set -e

echo
if [ -n "${NO_PULL}" ]; then
  echo "NO_PULL is set. Skipping pull."
else
  echo "Pulling ${DATA_TAG}"
  DIGEST_PRE=$(docker images -q --no-trunc ${DATA_TAG})
  docker pull ${DATA_TAG}
  DIGEST_POST=$(docker images -q --no-trunc ${DATA_TAG})
  echo "Pull done."
fi

if [ "${DIGEST_PRE}" != "${DIGEST_POST}" ]; then
  echo "New version of ${DATA_TAG} found. Data may not be what you expect."
  echo "Pre-pull digest: ${DIGEST_PRE}"
  echo "Post-pull digest: ${DIGEST_POST}"
  echo "Rerun if you are sure you want to use new data."
  echo "Exiting."
  exit 1
fi

echo
echo "Unpacking data"
CID=$(docker run -d -it ${DATA_TAG} sh)
docker cp ${CID}:/data.tar.gz /data.tar.gz
tar -xzvf /data.tar.gz -C /
docker kill ${CID} && docker rm ${CID}
echo "done."

echo
echo "Finished successfully!"
