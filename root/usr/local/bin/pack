#!/bin/sh

set -e
set -o pipefail

if [ -n "${REGISTRY}" ]; then
  IMAGE="${REGISTRY}/${DATA_TAG}"
else
  IMAGE="${DATA_TAG}"
fi


echo
echo "Packing data..."
tar -zcf /data.tar.gz -C /source .
echo "done."

echo
echo -n "Creating image..."
CID=$(docker run -d -it alpine:3.4 sh)
docker cp /data.tar.gz ${CID}:/data.tar.gz
COMMIT_RESULT=$(docker commit ${CID} ${IMAGE})
docker kill ${CID} && docker rm ${CID}
echo "done."
echo ${COMMIT_RESULT}

echo
if [ -n "${NO_PUSH}" ]; then
  echo "NO_PUSH is set, skipping push."
else

  if [ -n "${REGISTRY_USERNAME}" -o -n "${REGISTRY_ACCESS_TOKEN}" ]; then
    if [ -z "${REGISTRY_USERNAME}" ]; then
      echo "Missing REGISTRY_USERNAME. It is required when REGISTRY_ACCESS_TOKEN is set."
      exit 1
    fi
    if [ -z "${REGISTRY_ACCESS_TOKEN}" ]; then
      echo "Missing REGISTRY_ACCESS_TOKEN. It is required when REGISTRY_USERNAME is set."
      exit 1
    fi

    echo "Logging in to ${REGISTRY} with username ${REGISTRY_USERNAME}"
    docker login ${REGISTRY} -u ${REGISTRY_USERNAME} -p ${REGISTRY_ACCESS_TOKEN}
  fi

  echo -n "Pushing image..."
  PUSH_RESULT=$(docker push ${IMAGE})
  echo "done."
  echo ${PUSH_RESULT}
fi

echo
echo "Finished successfully."
