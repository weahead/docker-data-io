#!/bin/sh

set -e
set -o pipefail

echo
echo "Packing data..."
tar -zcf /data.tar.gz -C /source .
echo "done."

echo
echo -n "Creating image..."
CID=$(docker run -d -it alpine:3.4 sh)
docker cp /data.tar.gz ${CID}:/data.tar.gz
COMMIT_RESULT=$(docker commit ${CID} ${DATA_TAG})
docker kill ${CID} && docker rm ${CID}
echo "done."
echo ${COMMIT_RESULT}

echo
if [ -n "${NO_PUSH}" ]; then
  echo "NO_PUSH is set, skipping push."
else
  echo -n "Pushing image..."
  PUSH_RESULT=$(docker push ${DATA_TAG})
  echo "done."
  echo ${PUSH_RESULT}
fi

echo
echo "Finished successfully."
